<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Anderson's Library Auth</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-weight: bold;
        }
        .success { background: rgba(46, 213, 115, 0.3); color: #2ed573; }
        .error { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; }
        .warning { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
        .info { background: rgba(0, 123, 255, 0.3); color: #007bff; }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        button {
            background: #ffd93d;
            color: #1e3c72;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 217, 61, 0.4);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .config-input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .config-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .test-results {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Anderson's Library - Authentication Test</h1>
        <div class="info status">
            Test your Google Drive authentication before full deployment
        </div>

        <!-- Configuration Section -->
        <div class="test-section">
            <h3>‚öôÔ∏è Step 1: Configuration</h3>
            <p>Enter your credentials from Google Cloud Console (anderson-library project):</p>
            
            <label>Client ID:</label>
            <input type="text" id="clientIdInput" class="config-input" 
                   placeholder="123456789-abcdef.apps.googleusercontent.com">
            
            <label>API Key:</label>
            <input type="text" id="apiKeyInput" class="config-input" 
                   placeholder="AIzaSyC-your-api-key-here">
            
            <button onclick="updateConfig()">üíæ Update Configuration</button>
            <div id="configStatus" class="warning status" style="display: none;">
                Please enter your credentials above
            </div>
        </div>

        <!-- Test Steps -->
        <div class="test-section">
            <h3>üß™ Step 2: Run Tests</h3>
            <div id="testButtons">
                <button onclick="testGoogleAPI()" disabled id="testApiBtn">Test Google API Loading</button>
                <button onclick="testAuthentication()" disabled id="testAuthBtn">Test Authentication</button>
                <button onclick="testDriveAccess()" disabled id="testDriveBtn">Test Drive Access</button>
                <button onclick="testSheetsAccess()" disabled id="testSheetsBtn">Test Sheets Access</button>
                <button onclick="runAllTests()" disabled id="runAllBtn">üöÄ Run All Tests</button>
            </div>
        </div>

        <!-- Results -->
        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="overallStatus" class="info status">
                Ready to test - configure credentials first
            </div>
            <div id="testResults" class="test-results">
                Test log will appear here...
            </div>
        </div>

        <!-- Debug Info -->
        <div class="test-section">
            <h3>üîß Debug Information</h3>
            <div id="debugInfo" class="test-results">
                Debug information will appear here...
            </div>
        </div>
    </div>

    <script>
        // Test configuration
        let testConfig = {
            clientId: '',
            apiKey: '',
            scopes: [
                'https://www.googleapis.com/auth/drive.readonly',
                'https://www.googleapis.com/auth/userinfo.email',
                'https://www.googleapis.com/auth/spreadsheets'
            ]
        };

        let gapi;
        let authInstance;
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testResults.push(logEntry);
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.join('\n');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            console.log(logEntry);
        }

        function setOverallStatus(message, type = 'info') {
            const statusDiv = document.getElementById('overallStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateConfig() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!clientId || !apiKey) {
                document.getElementById('configStatus').style.display = 'block';
                document.getElementById('configStatus').textContent = 'Please enter both Client ID and API Key';
                return;
            }
            
            testConfig.clientId = clientId;
            testConfig.apiKey = apiKey;
            
            document.getElementById('configStatus').style.display = 'block';
            document.getElementById('configStatus').className = 'success status';
            document.getElementById('configStatus').textContent = '‚úÖ Configuration updated!';
            
            // Enable test buttons
            document.querySelectorAll('#testButtons button').forEach(btn => {
                btn.disabled = false;
            });
            
            setOverallStatus('Configuration set - ready to test!', 'success');
            log('‚úÖ Configuration updated successfully');
            
            // Display debug info
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `
Project: anderson-library (906077568035)
Client ID: ${testConfig.clientId ? testConfig.clientId.substring(0, 20) + '...' : 'Not set'}
API Key: ${testConfig.apiKey ? testConfig.apiKey.substring(0, 20) + '...' : 'Not set'}
Current URL: ${window.location.href}
User Agent: ${navigator.userAgent.substring(0, 50)}...
Time: ${new Date().toISOString()}
            `;
        }

        async function testGoogleAPI() {
            try {
                log('üîÑ Testing Google API loading...');
                setOverallStatus('Testing Google API...', 'info');
                
                // Load Google API
                if (typeof gapi === 'undefined') {
                    await loadGoogleAPI();
                }
                
                // Initialize client
                await new Promise((resolve, reject) => {
                    gapi.load('client:auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                log('‚úÖ Google API loaded successfully');
                setOverallStatus('Google API loaded!', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Google API test failed: ${error.message}`);
                setOverallStatus('Google API test failed', 'error');
                return false;
            }
        }

        async function testAuthentication() {
            try {
                log('üîÑ Testing authentication initialization...');
                setOverallStatus('Testing authentication...', 'info');
                
                if (!testConfig.clientId || !testConfig.apiKey) {
                    throw new Error('Configuration not set');
                }
                
                // Initialize Google API client
                await gapi.client.init({
                    apiKey: testConfig.apiKey,
                    clientId: testConfig.clientId,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ],
                    scope: testConfig.scopes.join(' ')
                });
                
                // Get auth instance
                authInstance = gapi.auth2.getAuthInstance();
                
                // Check if already signed in
                const isSignedIn = authInstance.isSignedIn.get();
                
                if (isSignedIn) {
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    log(`‚úÖ Already authenticated as: ${profile.getEmail()}`);
                } else {
                    log('‚úÖ Authentication initialized - ready for sign-in');
                }
                
                setOverallStatus('Authentication ready!', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Authentication test failed: ${error.message}`);
                setOverallStatus('Authentication test failed', 'error');
                return false;
            }
        }

        async function testDriveAccess() {
            try {
                log('üîÑ Testing Google Drive access...');
                setOverallStatus('Testing Drive access...', 'info');
                
                if (!authInstance) {
                    throw new Error('Authentication not initialized');
                }
                
                // Sign in if not already signed in
                if (!authInstance.isSignedIn.get()) {
                    log('üîê Signing in to Google...');
                    await authInstance.signIn();
                }
                
                // Test Drive API
                const response = await gapi.client.drive.files.list({
                    pageSize: 5,
                    fields: 'files(id,name,mimeType)'
                });
                
                const files = response.result.files;
                log(`‚úÖ Drive access successful! Found ${files.length} files:`);
                
                files.forEach(file => {
                    log(`  üìÑ ${file.name} (${file.mimeType})`);
                });
                
                setOverallStatus('Drive access working!', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Drive access test failed: ${error.message}`);
                setOverallStatus('Drive access test failed', 'error');
                return false;
            }
        }

        async function testSheetsAccess() {
            try {
                log('üîÑ Testing Google Sheets access...');
                setOverallStatus('Testing Sheets access...', 'info');
                
                if (!authInstance || !authInstance.isSignedIn.get()) {
                    throw new Error('Not authenticated');
                }
                
                // Test Sheets API with a simple spreadsheet creation
                const response = await gapi.client.sheets.spreadsheets.create({
                    resource: {
                        properties: {
                            title: 'Anderson Library Test - ' + new Date().toISOString()
                        }
                    }
                });
                
                const spreadsheetId = response.result.spreadsheetId;
                log(`‚úÖ Sheets access successful! Created test sheet: ${spreadsheetId}`);
                
                // Clean up - delete the test sheet
                try {
                    await gapi.client.drive.files.delete({
                        fileId: spreadsheetId
                    });
                    log('üóëÔ∏è Test sheet cleaned up');
                } catch (cleanupError) {
                    log('‚ö†Ô∏è Could not clean up test sheet (this is okay)');
                }
                
                setOverallStatus('Sheets access working!', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Sheets access test failed: ${error.message}`);
                setOverallStatus('Sheets access test failed', 'error');
                return false;
            }
        }

        async function runAllTests() {
            log('üöÄ Starting comprehensive test suite...');
            setOverallStatus('Running all tests...', 'info');
            
            const tests = [
                { name: 'Google API', fn: testGoogleAPI },
                { name: 'Authentication', fn: testAuthentication },
                { name: 'Drive Access', fn: testDriveAccess },
                { name: 'Sheets Access', fn: testSheetsAccess }
            ];
            
            let passedTests = 0;
            
            for (const test of tests) {
                log(`\n--- Testing ${test.name} ---`);
                try {
                    const result = await test.fn();
                    if (result) {
                        passedTests++;
                        log(`‚úÖ ${test.name} test passed`);
                    } else {
                        log(`‚ùå ${test.name} test failed`);
                    }
                } catch (error) {
                    log(`‚ùå ${test.name} test error: ${error.message}`);
                }
                
                // Wait a bit between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            log(`\nüèÅ Test suite complete: ${passedTests}/${tests.length} tests passed`);
            
            if (passedTests === tests.length) {
                setOverallStatus('üéâ All tests passed! Ready for production!', 'success');
            } else {
                setOverallStatus(`‚ö†Ô∏è ${passedTests}/${tests.length} tests passed - check errors above`, 'warning');
            }
        }

        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    gapi = window.gapi;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ Anderson\'s Library Authentication Test Ready');
            log('üìã Enter your credentials and click "Update Configuration" to begin');
            updateDebugInfo();
        });
    </script>
</body>
</html>